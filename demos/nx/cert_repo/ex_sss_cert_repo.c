/*
 *
 * Copyright 2022-2024 NXP
 * SPDX-License-Identifier: BSD-3-Clause
 */

/* ************************************************************************** */
/* Includes                                                                   */
/* ************************************************************************** */

#include "ex_sss_boot.h"
#include "nxEnsure.h"
#include "nxLog_msg.h"
#include <string.h>
#include "nx_apdu.h"
#include "nx_enums.h"
/* ************************************************************************** */
/* Local Defines                                                              */
/* ************************************************************************** */

#define EX_CERT_REPO_KEY_ID 3
#define EX_CERT_REPO_ID 3
#define EX_CERT_REPO_SIZE 0x1000

#define EX_CERT_REPO_DEVICE_LEAF_PRIVATE_KEY                                                                        \
    {                                                                                                               \
        0x89, 0xA1, 0x5F, 0x15, 0xFB, 0x93, 0x06, 0x03, 0x83, 0x87, 0x6B, 0x5F, 0xA3, 0x5A, 0xB3, 0x3F, 0x0F, 0x22, \
            0xB4, 0x9F, 0xD2, 0x8F, 0xF8, 0x27, 0xB3, 0x5F, 0xC9, 0x6E, 0xA2, 0x93, 0x13, 0xE7,                     \
    }
#define EX_CERT_REPO_DEVICE_LEAF_CERTIFICATE_BP256                                                                  \
    {                                                                                                               \
        0x30, 0x82, 0x01, 0xe9, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x02, 0xa0, 0x82, 0x01, \
            0xda, 0x30, 0x82, 0x01, 0xd6, 0x02, 0x01, 0x01, 0x31, 0x00, 0x30, 0x0b, 0x06, 0x09, 0x2a, 0x86, 0x48,   \
            0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0xa0, 0x82, 0x01, 0xbc, 0x30, 0x82, 0x01, 0xb8, 0x30, 0x82, 0x01,   \
            0x5f, 0x02, 0x14, 0x53, 0xdf, 0x85, 0x77, 0xcf, 0x62, 0x53, 0xd0, 0x1e, 0x61, 0x5a, 0xad, 0x88, 0xb4,   \
            0x0e, 0xf7, 0x9f, 0x9d, 0xb7, 0x8d, 0x30, 0x0a, 0x06, 0x08, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x04, 0x03,   \
            0x02, 0x30, 0x5f, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x4e, 0x4c, 0x31,   \
            0x12, 0x30, 0x10, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x09, 0x45, 0x69, 0x6e, 0x64, 0x68, 0x6f, 0x76,   \
            0x65, 0x6e, 0x31, 0x12, 0x30, 0x10, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x09, 0x45, 0x69, 0x6e, 0x64,   \
            0x68, 0x6f, 0x76, 0x65, 0x6e, 0x31, 0x0c, 0x30, 0x0a, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x03, 0x4e,   \
            0x58, 0x50, 0x31, 0x1a, 0x30, 0x18, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0c, 0x11, 0x43, 0x41, 0x20, 0x50,   \
            0x31, 0x20, 0x43, 0x45, 0x52, 0x54, 0x49, 0x46, 0x49, 0x43, 0x41, 0x54, 0x45, 0x30, 0x1e, 0x17, 0x0d,   \
            0x32, 0x33, 0x30, 0x37, 0x31, 0x31, 0x30, 0x37, 0x35, 0x31, 0x31, 0x34, 0x5a, 0x17, 0x0d, 0x33, 0x33,   \
            0x30, 0x37, 0x30, 0x38, 0x30, 0x37, 0x35, 0x31, 0x31, 0x34, 0x5a, 0x30, 0x5e, 0x31, 0x0b, 0x30, 0x09,   \
            0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x4e, 0x4c, 0x31, 0x12, 0x30, 0x10, 0x06, 0x03, 0x55, 0x04,   \
            0x08, 0x0c, 0x09, 0x45, 0x69, 0x6e, 0x64, 0x68, 0x6f, 0x76, 0x65, 0x6e, 0x31, 0x12, 0x30, 0x10, 0x06,   \
            0x03, 0x55, 0x04, 0x07, 0x0c, 0x09, 0x45, 0x69, 0x6e, 0x64, 0x68, 0x6f, 0x76, 0x65, 0x6e, 0x31, 0x0c,   \
            0x30, 0x0a, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x03, 0x4e, 0x58, 0x50, 0x31, 0x19, 0x30, 0x17, 0x06,   \
            0x03, 0x55, 0x04, 0x03, 0x0c, 0x10, 0x4c, 0x45, 0x41, 0x46, 0x20, 0x43, 0x45, 0x52, 0x54, 0x49, 0x46,   \
            0x49, 0x43, 0x41, 0x54, 0x45, 0x30, 0x5a, 0x30, 0x14, 0x06, 0x07, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x02,   \
            0x01, 0x06, 0x09, 0x2b, 0x24, 0x03, 0x03, 0x02, 0x08, 0x01, 0x01, 0x07, 0x03, 0x42, 0x00, 0x04, 0xa9,   \
            0x8d, 0xef, 0xc1, 0x9e, 0xbd, 0x83, 0x7a, 0xf5, 0x4f, 0x16, 0xaf, 0xbe, 0xc1, 0xd9, 0xba, 0x04, 0xaf,   \
            0x5c, 0x32, 0x1a, 0xb1, 0xc5, 0x76, 0x4c, 0x38, 0x43, 0xa3, 0x09, 0x84, 0x94, 0x4b, 0x0d, 0x78, 0x77,   \
            0x4d, 0xd9, 0x23, 0xda, 0x48, 0x79, 0xf8, 0xfb, 0x9f, 0xfb, 0xf8, 0x75, 0x76, 0xa9, 0x0c, 0x25, 0xea,   \
            0x13, 0x25, 0xb5, 0xa1, 0xea, 0x72, 0x7e, 0x69, 0xd3, 0x21, 0x52, 0xc8, 0x30, 0x0a, 0x06, 0x08, 0x2a,   \
            0x86, 0x48, 0xce, 0x3d, 0x04, 0x03, 0x02, 0x03, 0x47, 0x00, 0x30, 0x44, 0x02, 0x20, 0x69, 0xc2, 0xb7,   \
            0xad, 0xcc, 0xa6, 0x8e, 0xcb, 0x05, 0x29, 0xf9, 0x38, 0x84, 0xa7, 0xce, 0xca, 0x9a, 0x36, 0x97, 0xca,   \
            0x2d, 0x79, 0x5b, 0x21, 0x95, 0xf3, 0x99, 0x16, 0x8b, 0x23, 0x75, 0x27, 0x02, 0x20, 0x39, 0x9c, 0x4c,   \
            0x67, 0x16, 0x9d, 0x6d, 0x70, 0x62, 0x0c, 0x43, 0x5d, 0x99, 0x80, 0x78, 0x26, 0x3c, 0x6a, 0xcf, 0xcb,   \
            0xc3, 0x23, 0x87, 0x32, 0x98, 0xf0, 0x51, 0x70, 0xf0, 0x21, 0x78, 0xd0, 0xa1, 0x00, 0x31, 0x00,         \
    }
#define EX_CERT_REPO_DEVICE_P1_CERTIFICATE_BP256                                                                    \
    {                                                                                                               \
        0x30, 0x82, 0x02, 0x01, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x02, 0xa0, 0x82, 0x01, \
            0xf2, 0x30, 0x82, 0x01, 0xee, 0x02, 0x01, 0x01, 0x31, 0x00, 0x30, 0x0b, 0x06, 0x09, 0x2a, 0x86, 0x48,   \
            0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0xa0, 0x82, 0x01, 0xd4, 0x30, 0x82, 0x01, 0xd0, 0x30, 0x82, 0x01,   \
            0x77, 0xa0, 0x03, 0x02, 0x01, 0x02, 0x02, 0x14, 0x7a, 0xf9, 0x21, 0x3d, 0x3b, 0xef, 0xbc, 0x4c, 0x0b,   \
            0x0a, 0x0e, 0x7b, 0x46, 0xe1, 0x84, 0xce, 0xb3, 0xba, 0x08, 0x8b, 0x30, 0x0a, 0x06, 0x08, 0x2a, 0x86,   \
            0x48, 0xce, 0x3d, 0x04, 0x03, 0x02, 0x30, 0x5f, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06,   \
            0x13, 0x02, 0x4e, 0x4c, 0x31, 0x12, 0x30, 0x10, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x09, 0x45, 0x69,   \
            0x6e, 0x64, 0x68, 0x6f, 0x76, 0x65, 0x6e, 0x31, 0x12, 0x30, 0x10, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c,   \
            0x09, 0x45, 0x69, 0x6e, 0x64, 0x68, 0x6f, 0x76, 0x65, 0x6e, 0x31, 0x0c, 0x30, 0x0a, 0x06, 0x03, 0x55,   \
            0x04, 0x0a, 0x0c, 0x03, 0x4e, 0x58, 0x50, 0x31, 0x1a, 0x30, 0x18, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0c,   \
            0x11, 0x43, 0x41, 0x20, 0x50, 0x32, 0x20, 0x43, 0x45, 0x52, 0x54, 0x49, 0x46, 0x49, 0x43, 0x41, 0x54,   \
            0x45, 0x30, 0x1e, 0x17, 0x0d, 0x32, 0x33, 0x30, 0x37, 0x31, 0x31, 0x30, 0x37, 0x35, 0x31, 0x30, 0x39,   \
            0x5a, 0x17, 0x0d, 0x33, 0x33, 0x30, 0x37, 0x30, 0x38, 0x30, 0x37, 0x35, 0x31, 0x30, 0x39, 0x5a, 0x30,   \
            0x5f, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x4e, 0x4c, 0x31, 0x12, 0x30,   \
            0x10, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x09, 0x45, 0x69, 0x6e, 0x64, 0x68, 0x6f, 0x76, 0x65, 0x6e,   \
            0x31, 0x12, 0x30, 0x10, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x09, 0x45, 0x69, 0x6e, 0x64, 0x68, 0x6f,   \
            0x76, 0x65, 0x6e, 0x31, 0x0c, 0x30, 0x0a, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x03, 0x4e, 0x58, 0x50,   \
            0x31, 0x1a, 0x30, 0x18, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0c, 0x11, 0x43, 0x41, 0x20, 0x50, 0x31, 0x20,   \
            0x43, 0x45, 0x52, 0x54, 0x49, 0x46, 0x49, 0x43, 0x41, 0x54, 0x45, 0x30, 0x5a, 0x30, 0x14, 0x06, 0x07,   \
            0x2a, 0x86, 0x48, 0xce, 0x3d, 0x02, 0x01, 0x06, 0x09, 0x2b, 0x24, 0x03, 0x03, 0x02, 0x08, 0x01, 0x01,   \
            0x07, 0x03, 0x42, 0x00, 0x04, 0x0c, 0x4c, 0x58, 0x06, 0x7c, 0x85, 0x85, 0x2c, 0xc2, 0xce, 0xc0, 0x7a,   \
            0xf4, 0x04, 0x7a, 0xce, 0xd0, 0x36, 0x87, 0x48, 0xd6, 0x85, 0x32, 0xa4, 0xfb, 0xfc, 0x31, 0xb2, 0x9e,   \
            0x23, 0xf5, 0x0d, 0x03, 0x41, 0xd4, 0xf1, 0xcb, 0xd0, 0x80, 0x23, 0xf9, 0xa0, 0x93, 0x5e, 0x9f, 0x48,   \
            0xa6, 0x00, 0x8a, 0x63, 0xd4, 0x6d, 0x7b, 0xda, 0x95, 0x73, 0xde, 0x45, 0xce, 0x3e, 0x01, 0x5e, 0xab,   \
            0x42, 0xa3, 0x10, 0x30, 0x0e, 0x30, 0x0c, 0x06, 0x03, 0x55, 0x1d, 0x13, 0x04, 0x05, 0x30, 0x03, 0x01,   \
            0x01, 0xff, 0x30, 0x0a, 0x06, 0x08, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x04, 0x03, 0x02, 0x03, 0x47, 0x00,   \
            0x30, 0x44, 0x02, 0x20, 0x0c, 0x17, 0xe6, 0xe7, 0xbe, 0x49, 0x91, 0x48, 0x22, 0x60, 0x08, 0x90, 0xe0,   \
            0x01, 0xa8, 0x9b, 0x0e, 0x2e, 0x58, 0x26, 0x7c, 0x24, 0xea, 0x98, 0x3e, 0xfd, 0xc5, 0xea, 0x1c, 0x1a,   \
            0xa1, 0xca, 0x02, 0x20, 0x15, 0x99, 0x15, 0x94, 0x7d, 0x71, 0x55, 0x76, 0xf3, 0x21, 0x0a, 0x12, 0x28,   \
            0xa7, 0x2b, 0xbf, 0x39, 0x3b, 0x86, 0x57, 0x94, 0xfa, 0x78, 0x38, 0x9c, 0x12, 0x5d, 0xf9, 0x9a, 0x38,   \
            0x44, 0x4d, 0xa1, 0x00, 0x31, 0x00                                                                      \
    }
#define EX_CERT_REPO_DEVICE_P2_CERTIFICATE_BP256                                                                    \
    {                                                                                                               \
        0x30, 0x82, 0x01, 0xfe, 0x06, 0x09, 0x2a, 0x86, 0x48, 0x86, 0xf7, 0x0d, 0x01, 0x07, 0x02, 0xa0, 0x82, 0x01, \
            0xef, 0x30, 0x82, 0x01, 0xeb, 0x02, 0x01, 0x01, 0x31, 0x00, 0x30, 0x0b, 0x06, 0x09, 0x2a, 0x86, 0x48,   \
            0x86, 0xf7, 0x0d, 0x01, 0x07, 0x01, 0xa0, 0x82, 0x01, 0xd1, 0x30, 0x82, 0x01, 0xcd, 0x30, 0x82, 0x01,   \
            0x74, 0xa0, 0x03, 0x02, 0x01, 0x02, 0x02, 0x14, 0x42, 0xd8, 0xfa, 0x38, 0x7d, 0xac, 0x01, 0x6c, 0xb1,   \
            0x5b, 0x27, 0x79, 0x72, 0xb2, 0x63, 0x58, 0x2a, 0x77, 0x86, 0xe7, 0x30, 0x0a, 0x06, 0x08, 0x2a, 0x86,   \
            0x48, 0xce, 0x3d, 0x04, 0x03, 0x02, 0x30, 0x5c, 0x31, 0x0b, 0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06,   \
            0x13, 0x02, 0x4e, 0x4c, 0x31, 0x12, 0x30, 0x10, 0x06, 0x03, 0x55, 0x04, 0x08, 0x0c, 0x09, 0x45, 0x69,   \
            0x6e, 0x64, 0x68, 0x6f, 0x76, 0x65, 0x6e, 0x31, 0x12, 0x30, 0x10, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c,   \
            0x09, 0x45, 0x69, 0x6e, 0x64, 0x68, 0x6f, 0x76, 0x65, 0x6e, 0x31, 0x0c, 0x30, 0x0a, 0x06, 0x03, 0x55,   \
            0x04, 0x0a, 0x0c, 0x03, 0x4e, 0x58, 0x50, 0x31, 0x17, 0x30, 0x15, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0c,   \
            0x0e, 0x43, 0x41, 0x20, 0x43, 0x45, 0x52, 0x54, 0x49, 0x46, 0x49, 0x43, 0x41, 0x54, 0x45, 0x30, 0x1e,   \
            0x17, 0x0d, 0x32, 0x33, 0x30, 0x37, 0x31, 0x31, 0x30, 0x37, 0x35, 0x31, 0x30, 0x35, 0x5a, 0x17, 0x0d,   \
            0x33, 0x33, 0x30, 0x37, 0x30, 0x38, 0x30, 0x37, 0x35, 0x31, 0x30, 0x35, 0x5a, 0x30, 0x5f, 0x31, 0x0b,   \
            0x30, 0x09, 0x06, 0x03, 0x55, 0x04, 0x06, 0x13, 0x02, 0x4e, 0x4c, 0x31, 0x12, 0x30, 0x10, 0x06, 0x03,   \
            0x55, 0x04, 0x08, 0x0c, 0x09, 0x45, 0x69, 0x6e, 0x64, 0x68, 0x6f, 0x76, 0x65, 0x6e, 0x31, 0x12, 0x30,   \
            0x10, 0x06, 0x03, 0x55, 0x04, 0x07, 0x0c, 0x09, 0x45, 0x69, 0x6e, 0x64, 0x68, 0x6f, 0x76, 0x65, 0x6e,   \
            0x31, 0x0c, 0x30, 0x0a, 0x06, 0x03, 0x55, 0x04, 0x0a, 0x0c, 0x03, 0x4e, 0x58, 0x50, 0x31, 0x1a, 0x30,   \
            0x18, 0x06, 0x03, 0x55, 0x04, 0x03, 0x0c, 0x11, 0x43, 0x41, 0x20, 0x50, 0x32, 0x20, 0x43, 0x45, 0x52,   \
            0x54, 0x49, 0x46, 0x49, 0x43, 0x41, 0x54, 0x45, 0x30, 0x5a, 0x30, 0x14, 0x06, 0x07, 0x2a, 0x86, 0x48,   \
            0xce, 0x3d, 0x02, 0x01, 0x06, 0x09, 0x2b, 0x24, 0x03, 0x03, 0x02, 0x08, 0x01, 0x01, 0x07, 0x03, 0x42,   \
            0x00, 0x04, 0x41, 0x0b, 0x1f, 0x6d, 0x7c, 0xb6, 0xaa, 0x76, 0xe7, 0x45, 0x23, 0x58, 0x95, 0xef, 0x6a,   \
            0x46, 0x53, 0x17, 0xde, 0x82, 0x13, 0xe2, 0x14, 0xea, 0xfb, 0xb4, 0x9d, 0xab, 0xa7, 0x54, 0xdf, 0x90,   \
            0x3c, 0x24, 0x53, 0x84, 0xc0, 0x8d, 0xad, 0x73, 0x95, 0xf5, 0x08, 0xe9, 0xfa, 0x2b, 0xfb, 0x5c, 0xc5,   \
            0x23, 0x32, 0xf8, 0xc7, 0x68, 0x4c, 0x36, 0xe3, 0x20, 0x48, 0xa6, 0x40, 0x33, 0x4d, 0x9b, 0xa3, 0x10,   \
            0x30, 0x0e, 0x30, 0x0c, 0x06, 0x03, 0x55, 0x1d, 0x13, 0x04, 0x05, 0x30, 0x03, 0x01, 0x01, 0xff, 0x30,   \
            0x0a, 0x06, 0x08, 0x2a, 0x86, 0x48, 0xce, 0x3d, 0x04, 0x03, 0x02, 0x03, 0x47, 0x00, 0x30, 0x44, 0x02,   \
            0x20, 0x5a, 0x2e, 0x59, 0x33, 0x51, 0xec, 0x44, 0x39, 0x31, 0xc2, 0x06, 0xc9, 0x20, 0x4c, 0x19, 0xf3,   \
            0x75, 0xce, 0xd8, 0x3e, 0xb3, 0x6d, 0x85, 0x38, 0x92, 0xc0, 0x84, 0x1e, 0x62, 0x2a, 0x9b, 0x41, 0x02,   \
            0x20, 0x05, 0x90, 0xe4, 0x74, 0x6f, 0x30, 0x76, 0x3a, 0xf9, 0xa4, 0xa1, 0x0b, 0x44, 0x95, 0xa4, 0xb1,   \
            0x46, 0x9c, 0xcb, 0x91, 0xef, 0x9a, 0xc9, 0x64, 0x08, 0x42, 0x9d, 0x10, 0xae, 0x4b, 0xdd, 0xe0, 0xa1,   \
            0x00, 0x31, 0x00                                                                                        \
    }
#define EX_CERT_REPO_HOST_CERTIFICATE_MAPPING                                                           \
    {                                                                                                   \
        0xa0, 0x0e, 0x30, 0x81, 0xa0, 0x81, 0x30, 0x81, 0x02, 0x82, 0x31, 0x82, 0x30, 0x82, 0xa0, 0x83, \
    }

/* ************************************************************************** */
/* Structures and Typedefs                                                    */
/* ************************************************************************** */

/* ************************************************************************** */
/* Global Variables                                                           */
/* ************************************************************************** */

static ex_sss_boot_ctx_t gex_sss_cert_repo_boot_ctx;

/* ************************************************************************** */
/* Static function declarations                                               */
/* ************************************************************************** */

/* ************************************************************************** */
/* Private Functions                                                          */
/* ************************************************************************** */

/* ************************************************************************** */
/* Public Functions                                                           */
/* ************************************************************************** */

#define EX_SSS_BOOT_PCONTEXT (&gex_sss_cert_repo_boot_ctx)
#define EX_SSS_BOOT_EXPOSE_ARGC_ARGV 0

#include <ex_sss_main_inc.h>

static sss_status_t validate_certificate_length(size_t certLen);
static sss_status_t add_uncompressed_cert_tag(
    uint8_t *taggedCert, size_t *taggedCertLen, uint8_t *certBuf, size_t certBufLen);

static sss_status_t validate_certificate_length(size_t certLen)
{
    sss_status_t status   = kStatus_SSS_Fail;
    size_t size_of_length = 0;

    // Boundary check for certificate size
    size_of_length = (certLen <= 0x7f ? 1 : (certLen <= 0xFF ? 2 : 3));

    ENSURE_OR_GO_CLEANUP((UINT_MAX - 2 - size_of_length) > certLen);
    // 7F 21 [Len] [Cert]
    ENSURE_OR_GO_CLEANUP((2 + size_of_length + certLen) <= NX_MAX_CERTIFICATE_SIZE);

    status = kStatus_SSS_Success;

cleanup:
    if (kStatus_SSS_Success != status) {
        LOG_E("Too large certificate.");
    }

    return status;
}

/**
 *  The function will create tagged certificate from input certificate.
 *
 * @param taggedCert[out] Pointer to tagged certificate.
 * @param taggedCertLen[out] Pointer to tagged certificate length.
 * @param certBuf[in] Pointer to input certificate.
 * @param certBufLen[in] Input certificate length.
 *
 * @returns Status of the operation
 * @retval #kStatus_SSS_Success The operation has completed successfully.
 * @retval #kStatus_SSS_Fail The operation has failed.
 */
static sss_status_t add_uncompressed_cert_tag(
    uint8_t *taggedCert, size_t *taggedCertLen, uint8_t *certBuf, size_t certBufLen)
{
    sss_status_t status = kStatus_SSS_Fail;
    int tlvRet          = 1;
    uint8_t *pCert      = NULL;

    ENSURE_OR_GO_CLEANUP(taggedCert != NULL);
    ENSURE_OR_GO_CLEANUP(taggedCertLen != NULL);
    ENSURE_OR_GO_CLEANUP(certBuf != NULL);

    taggedCert[0]  = NX_TAG_CERT_DATA;
    pCert          = &taggedCert[1];
    *taggedCertLen = 1;
    tlvRet =
        TLVSET_u8buf("cert", &pCert, taggedCertLen, NX_TAG_UNCOMPRESSED_CERT, certBuf, certBufLen, NX_MAX_BUF_SIZE_CMD);
    ENSURE_OR_GO_CLEANUP(tlvRet == 0);

    status = kStatus_SSS_Success;

cleanup:
    if (kStatus_SSS_Success != status) {
        LOG_E("Add certificate data tag failed.");
    }

    return status;
}

sss_status_t ex_sss_entry(ex_sss_boot_ctx_t *pCtx)
{
    sss_status_t status        = kStatus_SSS_Fail;
    sss_status_t ret           = kStatus_SSS_Fail;
    smStatus_t sm_status       = SM_NOT_OK;
    sss_nx_session_t *pSession = NULL;
    uint32_t keyId             = EX_CERT_REPO_KEY_ID;
    sss_object_t keyObject     = {0};
    uint8_t prvKey[]           = EX_CERT_REPO_DEVICE_LEAF_PRIVATE_KEY;
    uint8_t leafCertBuf[]      = EX_CERT_REPO_DEVICE_LEAF_CERTIFICATE_BP256;
    size_t leafCertBufLen      = sizeof(leafCertBuf);
    uint8_t p1CertBuf[]        = EX_CERT_REPO_DEVICE_P1_CERTIFICATE_BP256;
    size_t p1CertBufLen        = sizeof(p1CertBuf);
    uint8_t p2CertBuf[]        = EX_CERT_REPO_DEVICE_P2_CERTIFICATE_BP256;
    size_t p2CertBufLen        = sizeof(p2CertBuf);

    uint8_t taggedCert[NX_MAX_BUF_SIZE_CMD] = {0};
    size_t taggedCertLen                    = 0;
    uint8_t mappingBuf[]                    = EX_CERT_REPO_HOST_CERTIFICATE_MAPPING;
    size_t mappingBufLen                    = sizeof(mappingBuf);

    uint32_t repoId             = EX_CERT_REPO_ID;
    uint8_t repoWriteCommMode   = Nx_CommMode_FULL;
    uint8_t repoWriteAccessCond = Nx_AccessCondition_Auth_Required_0x0;
    uint8_t repoReadCommMode    = Nx_CommMode_FULL;
    uint8_t repoReadAccessCond  = Nx_AccessCondition_Auth_Required_0x0;
    sss_policy_u keyGenPolicy   = {.type = KPolicy_GenECKey,
        .policy                        = {.genEcKey = {
                       .freezeKUCLimit        = 0,
                       .cardUnilateralEnabled = 0,
                       .kucLimit              = 0,
                       .sdmEnabled            = 0,
                       .sigmaiEnabled         = 1,
                       .ecdhEnabled           = 0,
                       .eccSignEnabled        = 0,
                       .writeCommMode         = Nx_CommMode_FULL,
                       .writeAccessCond       = Nx_AccessCondition_Auth_Required_0x1,
                       .userCommMode          = Nx_CommMode_NA,
                   }}};
    sss_policy_t ec_key_policy  = {.nPolicies = 1, .policies = {&keyGenPolicy}};

    ENSURE_OR_GO_CLEANUP(NULL != pCtx);
    pSession = (sss_nx_session_t *)&pCtx->session;
    // This part of code not mandtory to user, this code used to make re-running the example possible.
    if (pSession->s_ctx.authType == knx_AuthType_SYMM_AUTH) {
        if (pSession->s_ctx.ctx.pdynSymmAuthCtx != NULL) {
            keyGenPolicy.policy.genEcKey.writeAccessCond = pSession->s_ctx.ctx.pdynSymmAuthCtx->keyNo;
        }
        else {
            LOG_E("Invalid symm auth context !!!");
        }
    }

    // Create device private key associated with this repository
    status = sss_key_object_init(&keyObject, &pCtx->ks);
    ENSURE_OR_GO_CLEANUP(status == kStatus_SSS_Success);

    status = sss_key_object_allocate_handle(
        &keyObject, keyId, kSSS_KeyPart_Private, kSSS_CipherType_EC_BRAINPOOL, 256, kKeyObject_Mode_Persistent);
    ENSURE_OR_GO_CLEANUP(status == kStatus_SSS_Success);

    status = sss_key_store_set_key(
        &pCtx->ks, &keyObject, prvKey, sizeof(prvKey), 256, &ec_key_policy, sizeof(ec_key_policy));
    ENSURE_OR_GO_CLEANUP(status == kStatus_SSS_Success);

    LOG_I("Set ECC private key (%u) associated with this repository.", keyId);

    // Create certificate repository.
    sm_status = nx_ManageCertRepo_CreateCertRepo(&((sss_nx_session_t *)pSession)->s_ctx,
        repoId,
        keyId,
        EX_CERT_REPO_SIZE,
        repoWriteCommMode,
        repoWriteAccessCond,
        repoReadCommMode,
        repoReadAccessCond,
        Nx_CommMode_NA);

    if (sm_status != SM_OK) {
        if (sm_status == SM_ERR_FILE_DUPLICATE) {
            LOG_I("cert repo already exist");
            ret = kStatus_SSS_Success;
            goto cleanup;
        }
        else {
            LOG_E("Create Cert repo Failed !!");
            ret = kStatus_SSS_Fail;
            goto cleanup;
        }
    }

    status = validate_certificate_length(leafCertBufLen);
    ENSURE_OR_GO_CLEANUP(status == kStatus_SSS_Success);

    status = validate_certificate_length(p1CertBufLen);
    ENSURE_OR_GO_CLEANUP(status == kStatus_SSS_Success);

    status = validate_certificate_length(p2CertBufLen);
    ENSURE_OR_GO_CLEANUP(status == kStatus_SSS_Success);

    // Load Tagged Device Leaf Certificate
    status = add_uncompressed_cert_tag(taggedCert, &taggedCertLen, leafCertBuf, leafCertBufLen);
    ENSURE_OR_GO_CLEANUP(status == kStatus_SSS_Success);

    sm_status = nx_ManageCertRepo_LoadCert(&((sss_nx_session_t *)pSession)->s_ctx,
        repoId,
        NX_CERTIFICATE_LEVEL_LEAF,
        taggedCert,
        (uint16_t)taggedCertLen,
        Nx_CommMode_NA);
    ENSURE_OR_GO_CLEANUP(sm_status == SM_OK);
    LOG_I("Load device leaf certificate Successful !!!");

    // Load Tagged Device P1 Certificate
    memset(taggedCert, 0, sizeof(taggedCert));
    taggedCertLen = 0;
    status        = add_uncompressed_cert_tag(taggedCert, &taggedCertLen, p1CertBuf, p1CertBufLen);
    ENSURE_OR_GO_CLEANUP(status == kStatus_SSS_Success);

    sm_status = nx_ManageCertRepo_LoadCert(&((sss_nx_session_t *)pSession)->s_ctx,
        repoId,
        NX_CERTIFICATE_LEVEL_P1,
        taggedCert,
        (uint16_t)taggedCertLen,
        Nx_CommMode_NA);
    ENSURE_OR_GO_CLEANUP(sm_status == SM_OK);
    LOG_I("Load device P1 certificate Successful !!!");

    // Load Tagged Device P2 Certificate
    memset(taggedCert, 0, sizeof(taggedCert));
    taggedCertLen = 0;
    status        = add_uncompressed_cert_tag(taggedCert, &taggedCertLen, p2CertBuf, p2CertBufLen);
    ENSURE_OR_GO_CLEANUP(status == kStatus_SSS_Success);

    sm_status = nx_ManageCertRepo_LoadCert(&((sss_nx_session_t *)pSession)->s_ctx,
        repoId,
        NX_CERTIFICATE_LEVEL_P2,
        taggedCert,
        (uint16_t)taggedCertLen,
        Nx_CommMode_NA);
    ENSURE_OR_GO_CLEANUP(sm_status == SM_OK);
    LOG_I("Load device P2 certificate Successful !!!");

    sm_status = nx_ManageCertRepo_LoadCertMapping(&((sss_nx_session_t *)pSession)->s_ctx,
        repoId,
        NX_CERTIFICATE_LEVEL_LEAF,
        mappingBuf,
        (uint16_t)mappingBufLen,
        Nx_CommMode_NA);
    ENSURE_OR_GO_CLEANUP(sm_status == SM_OK);
    LOG_I("Load leaf certificate mapping table for PKCS#7 wrapping Successful !!!");

    sm_status = nx_ManageCertRepo_LoadCertMapping(&((sss_nx_session_t *)pSession)->s_ctx,
        repoId,
        NX_CERTIFICATE_LEVEL_P1,
        mappingBuf,
        (uint16_t)mappingBufLen,
        Nx_CommMode_NA);
    ENSURE_OR_GO_CLEANUP(sm_status == SM_OK);
    LOG_I("Load P1 certificate mapping table for PKCS#7 wrapping Successful !!!");

    sm_status = nx_ManageCertRepo_LoadCertMapping(&((sss_nx_session_t *)pSession)->s_ctx,
        repoId,
        NX_CERTIFICATE_LEVEL_P2,
        mappingBuf,
        (uint16_t)mappingBufLen,
        Nx_CommMode_NA);
    ENSURE_OR_GO_CLEANUP(sm_status == SM_OK);
    LOG_I("Load P2 certificate mapping table for PKCS#7 wrapping Successful !!!");

    sm_status = nx_ManageCertRepo_ActivateRepo(&((sss_nx_session_t *)pSession)->s_ctx, repoId, Nx_CommMode_NA);
    ENSURE_OR_GO_CLEANUP(sm_status == SM_OK);

    LOG_I("Activate certificate repository Successful !!!");

    ret = kStatus_SSS_Success;
cleanup:
    if (kStatus_SSS_Success == ret) {
        LOG_I("ex_sss_cert_repo Example Success !!!...");
    }
    else {
        LOG_E("ex_sss_cert_repo Example Failed !!!...");
    }
    if (keyObject.keyStore != NULL) {
        sss_key_object_free(&keyObject);
    }
    return ret;
}
